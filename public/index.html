<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Form</title>
</head>
<body>
    <form id="subscription-form">
        <input type="email" id="email" placeholder="Enter your email">
        <input type="text" id="card-number" placeholder="Card Number">
        <input type="text" id="expiry" placeholder="Expiry (MM/YY)">
        <input type="text" id="cvc" placeholder="CVC">
        <button type="submit">Subscribe</button>
    </form>

    <script>
        document.getElementById('subscription-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const cardNumber = document.getElementById('card-number').value;
            const expiry = document.getElementById('expiry').value;
            const cvc = document.getElementById('cvc').value;

            try {
                const customerResponse = await fetch('/api/create-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });
                const customer = await customerResponse.json();

                const paymentMethodResponse = await fetch('/api/create-payment-method', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentMethodType: 'card',
                        paymentMethodDetails: {
                            number: cardNumber,
                            exp_month: expiry.split('/')[0],
                            exp_year: expiry.split('/')[1],
                            cvc: cvc
                        }
                    })
                });
                const paymentMethod = await paymentMethodResponse.json();

                await fetch('/api/attach-payment-method', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentMethodId: paymentMethod.id,
                        customerId: customer.id
                    })
                });

                const sessionResponse = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customerId: customer.id,
                        priceId: 'price_1PE3CfSASGjb3zqkjpRKQVkc',
                        successUrl: 'https://stripe-2.onrender.com/success.html',
                        cancelUrl: 'https://stripe-2.onrender.com/cancel.html'
                    })
                });
                const session = await sessionResponse.json();

                // Redirect the user to the checkout page
                window.location.href = session.url;
            } catch (error) {
                console.error('Subscription error:', error);
            }
        });
    </script>
</body>
</html>
